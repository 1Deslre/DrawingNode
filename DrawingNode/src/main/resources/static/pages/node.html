<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>关系图案例</title>
    <script src="../js/vue.js"></script>
    <script src="../js/echarts.js"></script>
    <script src="../js/axios-0.18.0.js"></script>
    <link rel="stylesheet" href="../css/node.css">
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <!--    <script src="../plugins/element-ui/index.js"></script>-->
    <!--    <link rel="stylesheet" href="../plugins/element-ui/index.css">-->
</head>

<body>
<div id="app" class="root">
    <nav class="navbar">
        <ul>
            <li>
                <label>
                    <el-input placeholder="输入案件号" v-model="caseObject.caseNumber" class="nav-input"
                              clearable></el-input>
                    <el-input placeholder="输入被查询人名" v-model="caseObject.caseName" class="nav-input"
                              clearable></el-input>
                    <el-input placeholder="输入被查询人身份证" v-model="caseObject.caseCardId"
                              class="nav-input" clearable></el-input>
                </label>
                <el-button type="primary" @click="fetchDataByInput" class="nav-button">查询</el-button>
            </li>
            <li>
                <label>
                    <el-select v-model="selectedCaseNumber" placeholder="选择已有案件号" class="nav-select"
                               clearable>
                        <el-option v-for="caseNum in caseNumbers" :key="caseNum" :label="caseNum"
                                   :value="caseNum"></el-option>
                    </el-select>
                </label>
                <el-button type="primary" @click="getCaseNumberData" class="nav-button">查询</el-button>
            </li>
        </ul>
    </nav>
    <div id="chart-container">
        <div id="chart1" v-show="hasData"></div>
        <img v-if="!hasData" src="/img/404.webp" alt="显示失败" class="no-data-img">
    </div>
</div>
<script type="text/javascript">
    const vm = new Vue({
        el: '#app',
        data: {
            caseObject: {
                caseNumber: '',
                caseName: '',
                caseCardId: '',
            },
            echartsData: {
                chartData: null,
                categories: null,
                links: null,
            },
            caseNumbers: [],
            chartInstance: null,
            selectedCaseNumber: '',
            caseTitle: '',
            code: 200
        },
        computed: {
            hasData() {
                return this.echartsData.chartData != null;
            }
        },
        mounted() {
            this.fetchAllCaseNumbers();
            window.addEventListener('resize', this.resizeChart);
        },
        methods: {
            fetchAllCaseNumbers() {
                axios.get('/operation/allCase')
                    .then(response => {
                        this.caseNumbers = response.data.data;
                    })
                    .catch(error => {
                        this.$message.error("Error fetching case numbers: " + error);
                    });
            },
            fetchDataByInput() {
                if (!this.caseObject.caseNumber) {
                    this.$message.warning('请输入案件号');
                    return;
                }
                axios.post(`/operation/inquire`, this.caseObject, {
                    headers: {
                        'Content-Type': 'application/json;charset=utf-8'
                    }
                })
                    .then(response => {
                        const data = response.data;

                        if (data.code !== this.code) {
                            this.$message.error(data.message);
                            return
                        }
                        this.echartsData.chartData = data.data.nodes;
                        this.echartsData.links = data.data.links;
                        this.echartsData.categories = data.data.categories;
                        this.caseTitle = this.caseTitleName(this.caseObject.caseNumber);
                        this.$nextTick(() => {
                            this.initChart();
                            this.resizeChart();
                        });
                        this.queryOpen('成功', this.caseObject.caseNumber + '查询成功', 'success')
                    })
                    .catch(error => {
                        this.$message.error("服务器异常: " + error);
                    });
            },

            getCaseNumberData() {
                if (this.selectedCaseNumber === '') {
                    this.$message.warning('请选择案件号');
                    return;
                }
                axios.post(`/operation/inquire/${this.selectedCaseNumber}`, {
                    headers: {
                        'Content-Type': 'application/json;charset=utf-8'
                    }
                }).then(response => {
                    const data = response.data;
                    console.log('131------------', data)
                    if (data.code !== this.code) {
                        this.$message.error(data.message);
                        return
                    }
                    this.echartsData.chartData = data.data.nodes;
                    this.echartsData.links = data.data.links;
                    this.echartsData.categories = data.data.categories;
                    this.caseTitle = this.caseTitleName(this.selectedCaseNumber);
                    this.$nextTick(() => {
                        this.initChart();
                        this.resizeChart();
                    });
                    this.queryOpen('成功', this.selectedCaseNumber + '查询成功', 'success')
                })
                    .catch(error => {
                        this.$message.error("服务器异常: " + error);
                    });

            },

            caseTitleName(caseNumber) {
                return caseNumber + '关系图'
            },

            queryOpen(title, message, type) {
                this.$notify({
                    title: title,
                    message: message,
                    type: type
                });
            },


            initChart() {
                if (!this.echartsData.chartData || !this.echartsData.categories) return;

                var chart1 = echarts.init(document.getElementById('chart1'));

                var option = {
                    backgroundColor: '#fff',
                    title: {
                        text: this.caseTitle,
                        textStyle: {
                            color: '#000',
                            fontSize: '30',
                        }
                    },
                    tooltip: {
                        formatter: function (x) {
                            return x.data.des;
                        }
                    },
                    toolbox: {
                        show: true,
                        feature: {
                            mark: {show: true},
                            restore: {show: true},
                            saveAsImage: {show: true}
                        }
                    },
                    legend: [{
                        data: this.echartsData.categories.map(function (a) {
                            return a.name;
                        })
                    }],
                    series: [{
                        type: 'graph',
                        layout: 'force',
                        symbolSize: 40,
                        focusNodeAdjacency: true,
                        legendHoverLink: false,
                        roam: true,
                        force: {
                            repulsion: 500,
                            edgeLength: [150, 100]
                        },
                        draggable: true,
                        lineStyle: {
                            color: 'source',
                            width: 2
                        },
                        edgeLabel: {
                            normal: {
                                show: true,
                                formatter: function (x) {
                                    return x.data.name;
                                }
                            }
                        },
                        label: {
                            position: 'right',
                            formatter: '{b}',
                            normal: {
                                show: true,
                                textStyle: {}
                            }
                        },
                        emphasis: {
                            focus: 'adjacency',
                            lineStyle: {
                                width: 10
                            }
                        },
                        data: this.echartsData.chartData,
                        links: this.echartsData.links,
                        categories: this.echartsData.categories,
                    }]
                };

                chart1.setOption(option);
                this.chartInstance = chart1;
            },
            resizeChart() {
                if (this.chartInstance) {
                    this.chartInstance.resize();
                }
            }
        },
        beforeDestroy() {
            window.removeEventListener('resize', this.resizeChart);
        }
    });
</script>

</body>

</html>
